import React, { useState, useEffect } from 'react';
import { theme } from '../styles/theme';
import DiscussionStats from '../components/DiscussionStats';
import InteractionGraph from '../components/InteractionGraph';

export default function ChatRoom() {
  const [messages, setMessages] = useState([]);
  const [topic, setTopic] = useState('');
  const [isDiscussionStarted, setIsDiscussionStarted] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [isSummarizing, setIsSummarizing] = useState(false);
  const [showTopicSuggestions, setShowTopicSuggestions] = useState(false);
  
  const topicSuggestions = [
    'å¦‚ä½•æé«˜å›¢é˜Ÿå·¥ä½œæ•ˆç‡ï¼Ÿ',
    'äººå·¥æ™ºèƒ½å¯¹æœªæ¥å°±ä¸šå¸‚åœºçš„å½±å“',
    'å¯æŒç»­å‘å±•ä¸ç¯ä¿ç­–ç•¥',
    'è¿œç¨‹å·¥ä½œçš„ä¼˜ç¼ºç‚¹åˆ†æ',
    'æ•°å­—åŒ–è½¬å‹é¢ä¸´çš„æŒ‘æˆ˜',
    'æé«˜åˆ›æ–°èƒ½åŠ›çš„æ–¹æ³•',
    'å…ƒå®‡å®™çš„å‘å±•å‰æ™¯',
    'åŒºå—é“¾æŠ€æœ¯çš„å•†ä¸šåº”ç”¨',
    'å¦‚ä½•å¹³è¡¡å·¥ä½œä¸ç”Ÿæ´»ï¼Ÿ',
    'å…¨çƒæ°”å€™å˜åŒ–åº”å¯¹ç­–ç•¥'
  ];
  
  const selectTopicSuggestion = (suggestion) => {
    setTopic(suggestion);
    setShowTopicSuggestions(false);
  };

  // æ¨¡æ‹Ÿçš„æ™ºèƒ½ä½“æ•°æ®
  const agents = [
    { id: 1, name: 'ä¸»æŒäºº', role: 'ä¸»æŒäºº', color: theme.colors.primary },
    { id: 2, name: 'åˆ›æ„è€…', role: 'åˆ›æ„è€…', color: '#4caf50' },
    { id: 3, name: 'æ‰¹è¯„è€…', role: 'æ‰¹è¯„è€…', color: '#f44336' },
    { id: 4, name: 'æ•´åˆè€…', role: 'æ•´åˆè€…', color: '#ff9800' },
  ];

  const startDiscussion = () => {
    if (!topic.trim()) {
      alert('è¯·è¾“å…¥è®¨è®ºè¯é¢˜');
      return;
    }

    setIsDiscussionStarted(true);
    
    // æ¨¡æ‹Ÿåˆå§‹æ¶ˆæ¯
    const initialMessages = [
      {
        id: 1,
        agentId: 1,
        text: `æ¬¢è¿å¤§å®¶å‚ä¸ä»Šå¤©çš„å¤´è„‘é£æš´è®¨è®ºã€‚æˆ‘ä»¬çš„è¯é¢˜æ˜¯ï¼š${topic}ã€‚è¯·å„ä½æŒ‰ç…§è‡ªå·±çš„è§’è‰²ç‰¹ç‚¹ï¼Œç§¯æå‘è¡¨è§è§£ã€‚`,
        timestamp: new Date().toISOString()
      }
    ];
    
    setMessages(initialMessages);
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ è°ƒç”¨åç«¯APIçš„é€»è¾‘ï¼Œå¯åŠ¨æ™ºèƒ½ä½“è®¨è®º
  };

  const resetDiscussion = () => {
    setIsDiscussionStarted(false);
    setMessages([]);
    setTopic('');
  };

  // æ ¹æ®agentIdè·å–å¯¹åº”çš„æ™ºèƒ½ä½“ä¿¡æ¯
  const getAgentById = (agentId) => {
    return agents.find(agent => agent.id === agentId) || {};
  };
  
  // è·å–è§’è‰²å¯¹åº”çš„é¢œè‰²
  const getRoleColor = (role) => {
    const roleColors = {
      'ä¸»æŒäºº': '#4A6FA5',
      'åˆ›æ„è€…': '#47B881',
      'æ‰¹è¯„è€…': '#D14343',
      'æ•´åˆè€…': '#9F7AEA',
      'åˆ†æè€…': '#3182CE',
      'æ‰§è¡Œè€…': '#DD6B20',
      'åè°ƒè€…': '#38A169',
      'ä¸“å®¶': '#805AD5',
      'è®°å½•è€…': '#718096',
      'å…¶ä»–': '#4A5568'
    };
    return roleColors[role] || roleColors['å…¶ä»–'];
  };
  
  // è·å–è§’è‰²å¯¹åº”çš„å›¾æ ‡
  const getRoleIcon = (role) => {
    const roleIcons = {
      'ä¸»æŒäºº': 'ğŸ‘¨â€ğŸ’¼',
      'åˆ›æ„è€…': 'ğŸ’¡',
      'æ‰¹è¯„è€…': 'ğŸ”',
      'æ•´åˆè€…': 'ğŸ”„',
      'åˆ†æè€…': 'ğŸ“Š',
      'æ‰§è¡Œè€…': 'ğŸ› ï¸',
      'åè°ƒè€…': 'ğŸ¤',
      'ä¸“å®¶': 'ğŸ§ ',
      'è®°å½•è€…': 'ğŸ“',
      'å…¶ä»–': 'ğŸ‘¤'
    };
    return roleIcons[role] || roleIcons['å…¶ä»–'];
  };
  
  // æ¨¡æ‹Ÿæ™ºèƒ½ä½“ç”Ÿæˆå›å¤
  const generateAgentResponse = (agentId, currentMessages) => {
    const agent = getAgentById(agentId);
    let responseText = '';
    
    switch(agent.role) {
      case 'ä¸»æŒäºº':
        responseText = `è®©æˆ‘ä»¬ç»§ç»­è®¨è®ºå…³äº"${topic}"çš„è¯é¢˜ã€‚è¯·${getAgentById(2).name}åˆ†äº«ä¸€äº›åˆ›æ–°çš„æƒ³æ³•ã€‚`;
        break;
      case 'åˆ›æ„è€…':
        responseText = `å…³äº"${topic}"ï¼Œæˆ‘æœ‰å‡ ä¸ªåˆ›æ–°çš„æƒ³æ³•ï¼š1. å¯ä»¥å°è¯•å¼•å…¥AIè¾…åŠ©å·¥å…·æé«˜æ•ˆç‡ï¼›2. å»ºç«‹å®šæœŸåé¦ˆæœºåˆ¶ï¼›3. é‡‡ç”¨æ•æ·å¼€å‘æ–¹æ³•è®ºã€‚`;
        break;
      case 'æ‰¹è¯„è€…':
        responseText = `æˆ‘è®¤ä¸ºåˆšæ‰æåˆ°çš„æƒ³æ³•æœ‰ä¸€äº›é—®é¢˜ï¼šAIå·¥å…·å¯èƒ½ä¼šå¢åŠ å­¦ä¹ æˆæœ¬ï¼Œåé¦ˆæœºåˆ¶å¦‚æœè®¾è®¡ä¸å½“å¯èƒ½ä¼šå¢åŠ å›¢é˜Ÿå‹åŠ›ã€‚æˆ‘ä»¬éœ€è¦æ›´è°¨æ…åœ°è¯„ä¼°è¿™äº›æ–¹æ¡ˆã€‚`;
        break;
      case 'æ•´åˆè€…':
        responseText = `ç»¼åˆå¤§å®¶çš„è§‚ç‚¹ï¼Œæˆ‘è®¤ä¸ºæˆ‘ä»¬å¯ä»¥å…ˆå°è§„æ¨¡è¯•ç‚¹AIå·¥å…·ï¼ŒåŒæ—¶å»ºç«‹è½»é‡çº§çš„åé¦ˆæœºåˆ¶ï¼Œé€æ­¥è°ƒæ•´å®Œå–„ï¼Œè¿™æ ·æ—¢èƒ½è·å¾—åˆ›æ–°æ”¶ç›Šï¼Œåˆèƒ½æ§åˆ¶é£é™©ã€‚`;
        break;
      default:
        responseText = `å…³äº"${topic}"ï¼Œæˆ‘æƒ³åˆ†äº«ä¸€ä¸‹æˆ‘çš„çœ‹æ³•...`;
    }
    
    return {
      id: currentMessages.length + 1,
      agentId: agentId,
      text: responseText,
      timestamp: new Date().toISOString()
    };
  };
  
  // ç»§ç»­è®¨è®ºï¼Œç”Ÿæˆæ–°çš„æ¶ˆæ¯
  const continueDiscussion = () => {
    setIsLoading(true);
    
    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
    setTimeout(() => {
      // ç¡®å®šä¸‹ä¸€ä¸ªå‘è¨€çš„æ™ºèƒ½ä½“
      let nextAgentId;
      if (messages.length === 0) {
        nextAgentId = 1; // ä¸»æŒäººå…ˆå‘è¨€
      } else {
        const lastAgentId = messages[messages.length - 1].agentId;
        // å¾ªç¯è®©å„ä¸ªæ™ºèƒ½ä½“å‘è¨€
        nextAgentId = lastAgentId >= 4 ? 1 : lastAgentId + 1;
      }
      
      const newMessage = generateAgentResponse(nextAgentId, messages);
      setMessages([...messages, newMessage]);
      setIsLoading(false);
    }, 1500);
  };
  
  // ç”Ÿæˆè®¨è®ºæ€»ç»“
  const summarizeDiscussion = () => {
    setIsSummarizing(true);
    
    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
    setTimeout(() => {
      const summaryMessage = {
        id: messages.length + 1,
        agentId: 1, // ä¸»æŒäººæ€»ç»“
        text: `å…³äº"${topic}"çš„è®¨è®ºæ€»ç»“ï¼š\n\n1. åˆ›æ„è€…æå‡ºäº†å¼•å…¥AIå·¥å…·ã€å»ºç«‹åé¦ˆæœºåˆ¶å’Œé‡‡ç”¨æ•æ·æ–¹æ³•çš„å»ºè®®\n2. æ‰¹è¯„è€…æŒ‡å‡ºäº†å¯èƒ½çš„å­¦ä¹ æˆæœ¬å’Œå‹åŠ›é—®é¢˜\n3. æ•´åˆè€…æå‡ºäº†æ¸è¿›å¼å®æ–½æ–¹æ¡ˆï¼Œå¹³è¡¡åˆ›æ–°å’Œé£é™©\n\næ€»ä½“è€Œè¨€ï¼Œå›¢é˜Ÿè¾¾æˆäº†é€šè¿‡å°è§„æ¨¡è¯•ç‚¹å’Œè¿­ä»£æ”¹è¿›æ¥æé«˜åä½œæ•ˆç‡çš„å…±è¯†ã€‚æ„Ÿè°¢å„ä½çš„å‚ä¸ï¼`,
        timestamp: new Date().toISOString(),
        isSummary: true
      };
      
      setMessages([...messages, summaryMessage]);
      setIsSummarizing(false);
    }, 2000);
  };

  return (
    <div style={{ padding: '1.5rem' }}>
      <h2 style={{ 
        fontSize: '1.5rem', 
        marginBottom: '1rem',
        color: theme.colors.primary,
        fontWeight: 'bold'
      }}>
        AIå¤šæ™ºèƒ½ä½“èŠå¤©å®¤
      </h2>
      
      {!isDiscussionStarted ? (
        <div style={{ 
          border: '1px solid #e0e0e0',
          borderRadius: '8px',
          padding: '1.5rem',
          backgroundColor: 'white',
          maxWidth: '600px',
          margin: '0 auto'
        }}>
          <h3 style={{ 
            marginBottom: '1rem',
            fontSize: '1.25rem',
            fontWeight: 'bold'
          }}>
            å¼€å§‹ä¸€åœºæ–°çš„å¤´è„‘é£æš´
          </h3>
          
          <div style={{ marginBottom: '1.5rem', position: 'relative' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem' }}>
              è®¨è®ºè¯é¢˜ï¼š
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.25rem' }}>
                <input 
                  type="text" 
                  value={topic} 
                  onChange={(e) => setTopic(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '1px solid #e0e0e0',
                    borderRadius: '4px',
                    fontSize: '1rem'
                  }}
                  placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•æé«˜å›¢é˜Ÿåä½œæ•ˆç‡ï¼Ÿ"
                />
                <button
                  onClick={() => setShowTopicSuggestions(!showTopicSuggestions)}
                  style={{
                    backgroundColor: theme.colors.primary,
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    padding: '0.5rem',
                    cursor: 'pointer',
                    minWidth: '80px'
                  }}
                >
                  è¯é¢˜å»ºè®®
                </button>
              </div>
            </label>
            
            {showTopicSuggestions && (
              <div style={{
                position: 'absolute',
                top: '100%',
                left: 0,
                right: 0,
                backgroundColor: 'white',
                border: '1px solid #ccc',
                borderRadius: '4px',
                zIndex: 10,
                maxHeight: '200px',
                overflowY: 'auto',
                boxShadow: '0 4px 8px rgba(0,0,0,0.1)'
              }}>
                {topicSuggestions.map((suggestion, index) => (
                  <div 
                    key={index}
                    onClick={() => selectTopicSuggestion(suggestion)}
                    style={{
                      padding: '0.5rem 1rem',
                      cursor: 'pointer',
                      borderBottom: index < topicSuggestions.length - 1 ? '1px solid #eee' : 'none',
                      transition: 'background-color 0.2s'
                    }}
                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#f5f5f5'}
                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = 'white'}
                  >
                    {suggestion}
                  </div>
                ))}
              </div>
            )}
          
          <div style={{ marginTop: '1rem' }}>
            <button 
              onClick={startDiscussion}
              style={{
                backgroundColor: theme.colors.primary,
                color: 'white',
                padding: '0.75rem 1.5rem',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                fontWeight: 'bold',
                fontSize: '1rem',
                width: '100%'
              }}
            >
              å¼€å§‹è®¨è®º
            </button>
          </div>
        </div>
      ) : (
        <div>
          {messages.length > 0 && (
            <div>
              <DiscussionStats messages={messages} agents={agents} />
              <InteractionGraph messages={messages} agents={agents} />
            </div>
          )}
          
          <div style={{ 
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '1rem'
          }}>
            <h3 style={{ fontWeight: 'bold' }}>å½“å‰è¯é¢˜ï¼š{topic}</h3>
            <button 
              onClick={resetDiscussion}
              style={{
                backgroundColor: '#f5f5f5',
                color: '#333',
                padding: '0.5rem 1rem',
                border: '1px solid #e0e0e0',
                borderRadius: '4px',
                cursor: 'pointer'
              }}
            >
              é‡ç½®è®¨è®º
            </button>
          </div>
          
          <div style={{ 
            border: '1px solid #e0e0e0',
            borderRadius: '8px',
            height: '500px',
            backgroundColor: 'white',
            overflowY: 'auto',
            padding: '1rem',
            marginBottom: '1rem'
          }}>
            {messages.length > 0 ? (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                {messages.map(message => {
                  const agent = getAgentById(message.agentId);
                  return (
                    <div 
                      key={message.id} 
                      style={{ 
                        marginBottom: '1rem', 
                        padding: '0.5rem', 
                        backgroundColor: 'transparent',
                        borderRadius: '8px',
                        animation: 'fadeIn 0.3s ease-in-out',
                        opacity: 1,
                        transform: 'translateY(0)',
                        transition: 'opacity 0.3s, transform 0.3s'
                      }}
                    >
                      <div style={{ display: 'flex', marginBottom: '0.5rem' }}>
                        <div style={{ 
                          width: '40px', 
                          height: '40px', 
                          borderRadius: '50%', 
                          backgroundColor: getRoleColor(agent.role), 
                          display: 'flex', 
                          justifyContent: 'center', 
                          alignItems: 'center', 
                          color: 'white', 
                          fontWeight: 'bold', 
                          marginRight: '0.75rem',
                          fontSize: '1.25rem',
                          boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                        }}>
                          {getRoleIcon(agent.role)}
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            marginBottom: '0.25rem'
                          }}>
                            <div style={{ fontWeight: 'bold', color: getRoleColor(agent.role) }}>
                              {agent.name || 'æœªçŸ¥æ™ºèƒ½ä½“'}
                            </div>
                            <div style={{ fontSize: '0.8rem', color: '#888' }}>
                              {new Date(message.timestamp).toLocaleTimeString()}
                            </div>
                          </div>
                          <div style={{ 
                            fontSize: '0.8rem', 
                            color: '#666', 
                            marginBottom: '0.5rem' 
                          }}>
                            {agent.role || 'æœªçŸ¥è§’è‰²'}
                          </div>
                          <div style={{ 
                            backgroundColor: message.isSummary ? '#f0f7ff' : 'white',
                            padding: '0.75rem 1rem',
                            borderRadius: '0 8px 8px 8px',
                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                            whiteSpace: 'pre-wrap',
                            lineHeight: '1.5',
                            border: message.isSummary ? `1px solid ${theme.colors.primary}` : '1px solid #e0e0e0'
                          }}>
                            {message.text}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div style={{ 
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '100%',
                color: '#666'
              }}>
                ç­‰å¾…æ™ºèƒ½ä½“å¼€å§‹è®¨è®º...
              </div>
            )}
          </div>
          
          <div style={{ 
            display: 'flex',
            justifyContent: 'space-between',
            gap: '1rem'
          }}>
            <button 
              onClick={continueDiscussion}
              disabled={isLoading || isSummarizing}
              style={{
                backgroundColor: isLoading ? '#cccccc' : theme.colors.primary,
                color: 'white',
                padding: '0.75rem 1.5rem',
                border: 'none',
                borderRadius: '4px',
                cursor: isLoading ? 'default' : 'pointer',
                fontWeight: 'bold',
                flex: 1,
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center'
              }}
            >
              {isLoading ? 'ç”Ÿæˆä¸­...' : 'ç»§ç»­è®¨è®º'}
            </button>
            
            <button 
              onClick={summarizeDiscussion}
              disabled={isLoading || isSummarizing || messages.length < 2}
              style={{
                backgroundColor: isSummarizing || messages.length < 2 ? '#cccccc' : '#4caf50',
                color: 'white',
                padding: '0.75rem 1.5rem',
                border: 'none',
                borderRadius: '4px',
                cursor: isSummarizing || messages.length < 2 ? 'default' : 'pointer',
                fontWeight: 'bold',
                flex: 1,
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center'
              }}
            >
              {isSummarizing ? 'æ€»ç»“ä¸­...' : 'æ€»ç»“è®¨è®º'}
            </button>
          </div>
        </div>
      )}
    </div>
  );
}