import React, { useState, useEffect } from 'react';
import { theme } from '../styles/theme';
import DiscussionStats from '../components/DiscussionStats';
import InteractionGraph from '../components/InteractionGraph';

export default function ChatRoom() {
  const [messages, setMessages] = useState([]);
  const [topic, setTopic] = useState('');
  const [isDiscussionStarted, setIsDiscussionStarted] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [isSummarizing, setIsSummarizing] = useState(false);
  const [showTopicSuggestions, setShowTopicSuggestions] = useState(false);
  
  const topicSuggestions = [
    'å¦‚ä½•æé«˜å›¢é˜Ÿå·¥ä½œæ•ˆç‡ï¼Ÿ',
    'äººå·¥æ™ºèƒ½å¯¹æœªæ¥å°±ä¸šå¸‚åœºçš„å½±å“',
    'å¯æŒç»­å‘å±•ä¸ç¯ä¿ç­–ç•¥',
    'è¿œç¨‹å·¥ä½œçš„ä¼˜ç¼ºç‚¹åˆ†æ',
    'æ•°å­—åŒ–è½¬å‹é¢ä¸´çš„æŒ‘æˆ˜',
    'æé«˜åˆ›æ–°èƒ½åŠ›çš„æ–¹æ³•',
    'å…ƒå®‡å®™çš„å‘å±•å‰æ™¯'
  ];
  
  const selectTopicSuggestion = (suggestion) => {
    setTopic(suggestion);
    setShowTopicSuggestions(false);
  };
  
  // æ¨¡æ‹Ÿçš„æ™ºèƒ½ä½“æ•°æ®
  const agents = [
    { id: 'agent1', name: 'å°æ˜', role: 'ä¸»æŒäºº', apiKey: 'mock-key-1', description: 'è´Ÿè´£å¼•å¯¼è®¨è®ºæ–¹å‘å’Œæ€»ç»“è§‚ç‚¹' },
    { id: 'agent2', name: 'å°çº¢', role: 'åˆ›æ„è€…', apiKey: 'mock-key-2', description: 'æä¾›åˆ›æ–°çš„æƒ³æ³•å’Œè§£å†³æ–¹æ¡ˆ' },
    { id: 'agent3', name: 'å°æ', role: 'æ‰¹è¯„è€…', apiKey: 'mock-key-3', description: 'è´¨ç–‘å‡è®¾å¹¶æŒ‡å‡ºæ½œåœ¨é—®é¢˜' },
    { id: 'agent4', name: 'å°å¼ ', role: 'åˆ†æè€…', apiKey: 'mock-key-4', description: 'åˆ†ææ•°æ®å’Œè¶‹åŠ¿ï¼Œæä¾›å®¢è§‚è§è§£' }
  ];
  
  const startDiscussion = () => {
    if (!topic.trim()) {
      alert('è¯·è¾“å…¥è®¨è®ºè¯é¢˜');
      return;
    }
    
    setIsDiscussionStarted(true);
    
    // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯ä½œä¸ºè®¨è®ºçš„å¼€å§‹
    const initialMessage = {
      id: Date.now().toString(),
      agentId: 'system',
      text: `è®¨è®ºè¯é¢˜: ${topic}`,
      timestamp: new Date().toISOString(),
      type: 'system'
    };
    
    setMessages([initialMessage]);
    continueDiscussion();
  };
  
  const resetDiscussion = () => {
    setMessages([]);
    setTopic('');
    setIsDiscussionStarted(false);
    setIsLoading(false);
    setIsSummarizing(false);
  };
  
  const getAgentById = (agentId) => {
    return agents.find(agent => agent.id === agentId) || { name: 'ç³»ç»Ÿ', role: 'ç³»ç»Ÿ' };
  };
  
  const getRoleColor = (role) => {
    const roleColors = {
      'ä¸»æŒäºº': '#4A6FA5',
      'åˆ›æ„è€…': '#47B881',
      'æ‰¹è¯„è€…': '#D14343',
      'æ•´åˆè€…': '#9F7AEA',
      'åˆ†æè€…': '#3182CE',
      'æ‰§è¡Œè€…': '#DD6B20',
      'åè°ƒè€…': '#38A169',
      'ä¸“å®¶': '#805AD5',
      'è®°å½•è€…': '#718096',
      'ç³»ç»Ÿ': '#4A5568'
    };
    return roleColors[role] || roleColors['ç³»ç»Ÿ'];
  };
  
  const getRoleIcon = (role) => {
    const roleIcons = {
      'ä¸»æŒäºº': 'ğŸ¯',
      'åˆ›æ„è€…': 'ğŸ’¡',
      'æ‰¹è¯„è€…': 'ğŸ”',
      'æ•´åˆè€…': 'ğŸ”„',
      'åˆ†æè€…': 'ğŸ“Š',
      'æ‰§è¡Œè€…': 'ğŸ› ï¸',
      'åè°ƒè€…': 'ğŸ¤',
      'ä¸“å®¶': 'ğŸ§ ',
      'è®°å½•è€…': 'ğŸ“',
      'ç³»ç»Ÿ': 'ğŸ¤–'
    };
    return roleIcons[role] || roleIcons['ç³»ç»Ÿ'];
  };
  
  const generateAgentResponse = (agentId, currentMessages) => {
    const agent = getAgentById(agentId);
    let responseText = '';
    
    switch(agent.role) {
      case 'ä¸»æŒäºº':
        responseText = `è®©æˆ‘ä»¬ç»§ç»­è®¨è®º"${topic}"ã€‚${currentMessages.length < 3 ? 'æ¯ä¸ªäººå¯ä»¥å…ˆåˆ†äº«ä¸€ä¸‹è‡ªå·±çš„åˆæ­¥æƒ³æ³•ã€‚' : 'æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€äº›è§‚ç‚¹ï¼Œå¯ä»¥æ›´æ·±å…¥åœ°æ¢è®¨ä¸€ä¸‹ã€‚'}`;
        break;
      case 'åˆ›æ„è€…':
        responseText = `æˆ‘æœ‰ä¸€ä¸ªåˆ›æ–°çš„æƒ³æ³•ï¼šæˆ‘ä»¬å¯ä»¥ä»${Math.random() > 0.5 ? 'æŠ€æœ¯è§’åº¦' : 'ç”¨æˆ·ä½“éªŒè§’åº¦'}æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼Œ${Math.random() > 0.5 ? 'åˆ©ç”¨æœ€æ–°çš„AIæŠ€æœ¯' : 'ç»“åˆè®¾è®¡æ€ç»´'}å¯èƒ½ä¼šå¸¦æ¥çªç ´æ€§çš„è§£å†³æ–¹æ¡ˆã€‚`;
        break;
      case 'æ‰¹è¯„è€…':
        responseText = `æˆ‘è®¤ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸‹æ½œåœ¨çš„é—®é¢˜ï¼š${Math.random() > 0.5 ? 'è¿™ä¸ªæ–¹æ¡ˆçš„æˆæœ¬å¯èƒ½è¿‡é«˜' : 'å®æ–½è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šé˜»åŠ›'}ã€‚æˆ‘ä»¬æ˜¯å¦å……åˆ†è¯„ä¼°äº†é£é™©ï¼Ÿ`;
        break;
      case 'åˆ†æè€…':
        responseText = `æ ¹æ®æˆ‘çš„åˆ†æï¼Œ${Math.random() > 0.5 ? 'å½“å‰çš„å¸‚åœºè¶‹åŠ¿è¡¨æ˜' : 'æ•°æ®æ˜¾ç¤º'}è¿™ä¸ªæ–¹å‘æ˜¯æœ‰æ½œåŠ›çš„ï¼Œä½†æˆ‘ä»¬éœ€è¦æ›´å¤šçš„${Math.random() > 0.5 ? 'ç”¨æˆ·åé¦ˆ' : 'å®éªŒæ•°æ®'}æ¥éªŒè¯æˆ‘ä»¬çš„å‡è®¾ã€‚`;
        break;
      default:
        responseText = `å…³äº"${topic}"ï¼Œæˆ‘è®¤ä¸º${Math.random() > 0.5 ? 'æˆ‘ä»¬åº”è¯¥ä»å¤šè§’åº¦æ€è€ƒ' : 'åˆ›æ–°å’Œå®ç”¨æ€§åŒæ ·é‡è¦'}ã€‚`;
    }
    
    return {
      id: Date.now().toString(),
      agentId: agentId,
      text: responseText,
      timestamp: new Date().toISOString(),
      type: 'message'
    };
  };
  
  const continueDiscussion = () => {
    setIsLoading(true);
    
    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
    setTimeout(() => {
      let nextAgentId;
      
      if (messages.length === 0) {
        nextAgentId = agents[0].id; // ç¬¬ä¸€ä¸ªæ™ºèƒ½ä½“å¼€å§‹
      } else {
        // ç¡®å®šä¸‹ä¸€ä¸ªå‘è¨€çš„æ™ºèƒ½ä½“
        const lastMessageAgentIndex = agents.findIndex(agent => 
          agent.id === messages[messages.length - 1].agentId
        );
        
        const nextAgentIndex = (lastMessageAgentIndex + 1) % agents.length;
        nextAgentId = agents[nextAgentIndex].id;
      }
      
      const newMessage = generateAgentResponse(nextAgentId, messages);
      setMessages(prevMessages => [...prevMessages, newMessage]);
      setIsLoading(false);
    }, 1500);
  };
  
  const summarizeDiscussion = () => {
    setIsSummarizing(true);
    
    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
    setTimeout(() => {
      const summaryMessage = {
        id: Date.now().toString(),
        agentId: 'system',
        text: `è®¨è®ºæ€»ç»“ï¼šå…³äº"${topic}"çš„è®¨è®ºä¸­ï¼Œå‚ä¸è€…æå‡ºäº†å¤šä¸ªè§‚ç‚¹ã€‚ä¸»è¦åŒ…æ‹¬äº†åˆ›æ–°æ€è·¯ã€æ½œåœ¨é—®é¢˜åˆ†æä»¥åŠæ•°æ®æ”¯æŒçš„è§è§£ã€‚å›¢é˜Ÿéœ€è¦è¿›ä¸€æ­¥æ·±å…¥æ¢è®¨å…·ä½“å®æ–½æ–¹æ¡ˆå’Œè¯„ä¼°å¯è¡Œæ€§ã€‚`,
        timestamp: new Date().toISOString(),
        type: 'summary'
      };
      
      setMessages(prevMessages => [...prevMessages, summaryMessage]);
      setIsSummarizing(false);
    }, 2000);
  };

  return (
    <div style={{ padding: '1.5rem' }}>
      <h2 style={{ 
        color: theme.colors.primary, 
        marginTop: 0, 
        marginBottom: '1.5rem',
        textAlign: 'center'
      }}>
        AIå¤šæ™ºèƒ½ä½“è®¨è®ºå®¤
      </h2>
      
      {!isDiscussionStarted ? (
        <div style={{
          maxWidth: '600px',
          margin: '0 auto',
          backgroundColor: 'white',
          padding: '2rem',
          borderRadius: '8px',
          boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
        }}>
          <h3 style={{ 
            color: theme.colors.primary, 
            marginTop: 0, 
            marginBottom: '1.5rem',
            textAlign: 'center'
          }}>
            å¼€å§‹æ–°è®¨è®º
          </h3>
          
          <div style={{ marginBottom: '1.5rem', position: 'relative' }}>
            <label htmlFor="topic" style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
              è®¨è®ºè¯é¢˜ï¼š
            </label>
            <input 
              id="topic"
              type="text" 
              value={topic}
              onChange={(e) => setTopic(e.target.value)}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '4px',
                border: '1px solid #ddd',
                fontSize: '1rem'
              }}
              placeholder="è¾“å…¥è®¨è®ºè¯é¢˜..."
            />
            
            <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.25rem' }}>
              <button 
                onClick={() => setShowTopicSuggestions(!showTopicSuggestions)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  color: theme.colors.primary,
                  cursor: 'pointer',
                  padding: '0.25rem 0',
                  fontSize: '0.875rem',
                  textDecoration: 'underline'
                }}
              >
                è¯é¢˜å»ºè®®
              </button>
            </div>
            
            {showTopicSuggestions && (
              <div style={{
                position: 'absolute',
                top: '100%',
                left: 0,
                right: 0,
                backgroundColor: 'white',
                border: '1px solid #ddd',
                borderRadius: '4px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                zIndex: 10,
                marginTop: '0.25rem'
              }}>
                {topicSuggestions.map((suggestion, index) => (
                  <div 
                    key={index}
                    onClick={() => selectTopicSuggestion(suggestion)}
                    style={{
                      padding: '0.75rem 1rem',
                      borderBottom: index < topicSuggestions.length - 1 ? '1px solid #eee' : 'none',
                      cursor: 'pointer'
                    }}
                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#f5f5f5'}
                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = 'white'}
                  >
                    {suggestion}
                  </div>
                ))}
              </div>
            )}
          </div>
          
          <button 
            onClick={startDiscussion}
            style={{
              backgroundColor: theme.colors.primary,
              color: 'white',
              padding: '0.75rem 1.5rem',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              fontWeight: 'bold',
              width: '100%',
              fontSize: '1rem'
            }}
          >
            å¼€å§‹è®¨è®º
          </button>
        </div>
      ) : (
        <div>
          {messages.length > 0 && (
            <>
              <DiscussionStats messages={messages} agents={agents} />
              <InteractionGraph messages={messages} agents={agents} />
            </>
          )}
          
          <div style={{
            backgroundColor: 'white',
            borderRadius: '8px',
            padding: '1rem',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            marginBottom: '1rem'
          }}>
            <button 
              onClick={resetDiscussion}
              style={{
                backgroundColor: '#f44336',
                color: 'white',
                padding: '0.5rem 1rem',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                marginBottom: '1rem'
              }}
            >
              é‡ç½®è®¨è®º
            </button>
            
            <div style={{
              maxHeight: '400px',
              overflowY: 'auto',
              padding: '0.5rem'
            }}>
              {messages.length > 0 ? (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                  {messages.map(message => {
                    const agent = getAgentById(message.agentId);
                    return (
                      <div 
                        key={message.id}
                        style={{
                          opacity: 0,
                          animation: 'fadeIn 0.3s forwards',
                          animationDelay: '0.1s',
                          transform: 'translateY(10px)',
                          transition: 'transform 0.3s ease-out'
                        }}
                      >
                        <div style={{ display: 'flex', marginBottom: '0.5rem' }}>
                          <div style={{
                            width: '36px',
                            height: '36px',
                            borderRadius: '50%',
                            backgroundColor: getRoleColor(agent.role),
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            marginRight: '0.75rem',
                            color: 'white',
                            fontWeight: 'bold',
                            fontSize: '1.25rem'
                          }}>
                            {getRoleIcon(agent.role)}
                          </div>
                          
                          <div style={{ flex: 1 }}>
                            <div style={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center'
                            }}>
                              <div style={{ fontWeight: 'bold', color: getRoleColor(agent.role) }}>
                                {agent.name || 'æœªçŸ¥æ™ºèƒ½ä½“'}
                              </div>
                              <div style={{ fontSize: '0.8rem', color: '#888' }}>
                                {new Date(message.timestamp).toLocaleTimeString()}
                              </div>
                            </div>
                            
                            <div style={{
                              fontSize: '0.8rem',
                              color: '#666',
                              marginBottom: '0.25rem'
                            }}>
                              {agent.role || 'æœªçŸ¥è§’è‰²'}
                            </div>
                            
                            <div style={{
                              backgroundColor: message.type === 'system' ? '#f5f5f5' : 
                                            message.type === 'summary' ? '#e8f4f8' : '#f9f9f9',
                              padding: '0.75rem',
                              borderRadius: '4px',
                              boxShadow: '0 1px 2px rgba(0,0,0,0.05)',
                              whiteSpace: 'pre-wrap',
                              lineHeight: '1.5',
                              border: message.type === 'summary' ? '1px dashed #4A6FA5' : 'none'
                            }}>
                              {message.text}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div style={{
                  display: 'flex',
                  justifyContent: 'center',
                  alignItems: 'center',
                  height: '100%',
                  color: '#666'
                }}>
                  ç­‰å¾…æ™ºèƒ½ä½“å¼€å§‹è®¨è®º...
                </div>
              )}
            </div>


            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              gap: '1rem'
            }}>
              <button 
                onClick={continueDiscussion}
                disabled={isLoading || isSummarizing}
                style={{
                  backgroundColor: isLoading ? '#cccccc' : theme.colors.primary,
                  color: 'white',
                  padding: '0.75rem 1.5rem',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: isLoading ? 'default' : 'pointer',
                  fontWeight: 'bold',
                  flex: 1,
                  display: 'flex',
                  justifyContent: 'center',
                  alignItems: 'center'
                }}
              >
                {isLoading ? 'ç”Ÿæˆä¸­...' : 'ç»§ç»­è®¨è®º'}
              </button>
              
              <button 
                onClick={summarizeDiscussion}
                disabled={isLoading || isSummarizing || messages.length < 2}
                style={{
                  backgroundColor: isSummarizing || messages.length < 2 ? '#cccccc' : '#4caf50',
                  color: 'white',
                  padding: '0.75rem 1.5rem',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: isSummarizing || messages.length < 2 ? 'default' : 'pointer',
                  fontWeight: 'bold',
                  flex: 1,
                  display: 'flex',
                  justifyContent: 'center',
                  alignItems: 'center'
                }}
              >
                {isSummarizing ? 'æ€»ç»“ä¸­...' : 'æ€»ç»“è®¨è®º'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}